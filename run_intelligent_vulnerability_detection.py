#!/usr/bin/env python3
"""
æ™ºèƒ½æ¼æ´æ£€æµ‹è¿è¡Œå™¨
é›†æˆç»“æœå­˜å‚¨ã€ç»Ÿè®¡åˆ†æå’Œæ™ºèƒ½promptä¼˜åŒ–
"""

import os
import sys
import argparse
import time
from typing import List, Dict, Any

# æ·»åŠ EvoPromptè·¯å¾„
sys.path.append("./")

from args import parse_args
from utils import set_seed, setup_log
from enhanced_vulnerability_evaluator import create_enhanced_evaluator
from intelligent_evolution import IntelligentEvolutionManager
from evolution_tracker import create_evolution_tracker
from run_vulnerability_detection import setup_vulnerability_detection_data


def main():
    """æ™ºèƒ½æ¼æ´æ£€æµ‹ä¸»å‡½æ•°"""
    print("ğŸ§  Starting Intelligent Vulnerability Detection System")
    print("=" * 60)
    
    # è§£æå‚æ•°
    args = parse_args()
    
    # è®¾ç½®ä»»åŠ¡ç±»å‹ï¼ˆå¦‚æœæœªæŒ‡å®šï¼‰
    if not hasattr(args, 'task') or not args.task:
        args.task = "vul_detection"
    
    # è®¾ç½®é»˜è®¤å‚æ•°
    if not hasattr(args, 'dataset') or not args.dataset:
        args.dataset = "sven"
    
    # è®¾ç½®language_modelå‚æ•°ï¼ˆevaluator.pyéœ€è¦ï¼‰
    if not hasattr(args, 'language_model') or not args.language_model:
        args.language_model = "gpt-3.5-turbo"
    
    # è®¾ç½®è¾“å‡ºç›®å½•
    if not hasattr(args, 'output') or not args.output:
        args.output = f"./outputs/intelligent_vul_detection/{args.dataset}/"
    
    # åˆ›å»ºè¾“å‡ºç›®å½•
    os.makedirs(args.output, exist_ok=True)
    
    # è®¾ç½®ç§å­
    set_seed(args.seed)
    
    print(f"ğŸ“Š Configuration:")
    print(f"  Dataset: {args.dataset}")
    print(f"  Evolution Mode: {args.evo_mode}")
    print(f"  Population Size: {args.popsize}")
    print(f"  Generations: {args.budget}")
    print(f"  Sample Size: {args.sample_num}")
    print(f"  Output Directory: {args.output}")
    print("")
    
    try:
        # è®¾ç½®æ•°æ®
        print("ğŸ“ Setting up vulnerability detection data...")
        setup_vulnerability_detection_data(args)
        
        # åˆ›å»ºå¢å¼ºç‰ˆè¯„ä¼°å™¨
        print("ğŸ”¬ Creating enhanced evaluator...")
        evaluator = create_enhanced_evaluator(args)
        
        # åˆ›å»ºæ™ºèƒ½è¿›åŒ–ç®¡ç†å™¨
        print("ğŸ§  Creating intelligent evolution manager...")
        manager = IntelligentEvolutionManager(args, evaluator)
        
        # è¿è¡Œæ™ºèƒ½è¿›åŒ–
        print("ğŸš€ Starting intelligent evolution process...")
        print("=" * 60)
        
        start_time = time.time()
        manager.run_intelligent_evolution()
        elapsed_time = time.time() - start_time
        
        print("=" * 60)
        print("âœ… Intelligent vulnerability detection completed!")
        print(f"â±ï¸ Total time: {elapsed_time:.2f} seconds")
        
        # æ˜¾ç¤ºç»“æœæ‘˜è¦
        summary = evaluator.get_experiment_summary()
        print(f"ğŸ“Š Results Summary:")
        print(f"  Experiment: {summary.get('experiment_name', 'N/A')}")
        print(f"  Total Generations: {summary.get('total_generations', 0)}")
        print(f"  Best Score: {summary.get('best_score', 0):.4f}")
        print(f"  Final Avg Score: {summary.get('final_avg_score', 0):.4f}")
        print(f"  Cache Entries: {summary.get('cache_entries', 0)}")
        print(f"ğŸ“ Results saved in: {args.output}")
        
        # æä¾›åç»­åˆ†æå»ºè®®
        print("\nğŸ’¡ Next Steps:")
        print("  1. Check the analysis reports in the output directory")
        print("  2. Review the optimization strategies generated")
        print("  3. Use the best prompts for production vulnerability detection")
        print("  4. Consider fine-tuning based on the statistical insights")
        
    except KeyboardInterrupt:
        print("\nâš ï¸ Process interrupted by user")
        print("ğŸ’¾ Partial results may be saved in the output directory")
        
    except Exception as e:
        print(f"\nâŒ Intelligent vulnerability detection failed: {e}")
        print("\nğŸ”§ Troubleshooting tips:")
        print("  - Check your .env configuration")
        print("  - Ensure API_KEY is set correctly")
        print("  - Verify API endpoints are accessible")
        print("  - Try reducing popsize and budget for testing")
        
        # ä¿å­˜é”™è¯¯ä¿¡æ¯
        error_log = os.path.join(args.output, "error.log")
        with open(error_log, 'w') as f:
            import traceback
            f.write(f"Error occurred at: {time.strftime('%Y-%m-%d %H:%M:%S')}\n")
            f.write(f"Error message: {str(e)}\n")
            f.write(f"Traceback:\n{traceback.format_exc()}")
        
        print(f"ğŸ“ Error details saved to: {error_log}")
        
        raise


def create_intelligent_analysis_report(output_dir: str):
    """åˆ›å»ºæ™ºèƒ½åˆ†ææŠ¥å‘Šï¼ˆç‹¬ç«‹åŠŸèƒ½ï¼‰"""
    print("ğŸ“Š Creating intelligent analysis report...")
    
    # è¿™é‡Œå¯ä»¥æ·»åŠ ç¦»çº¿åˆ†æåŠŸèƒ½
    # ä¾‹å¦‚è¯»å–å·²æœ‰çš„å®éªŒæ•°æ®ï¼Œç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
    
    pass


def batch_run_experiments(configs: List[Dict[str, Any]]):
    """æ‰¹é‡è¿è¡Œå®éªŒï¼ˆé«˜çº§åŠŸèƒ½ï¼‰"""
    print("ğŸ”„ Running batch experiments...")
    
    results = []
    
    for i, config in enumerate(configs):
        print(f"\nğŸ§ª Running experiment {i+1}/{len(configs)}")
        print(f"Config: {config}")
        
        # åˆ›å»ºå‚æ•°å¯¹è±¡
        class BatchArgs:
            def __init__(self, config_dict):
                for key, value in config_dict.items():
                    setattr(self, key, value)
        
        args = BatchArgs(config)
        
        try:
            # è¿è¡Œå•ä¸ªå®éªŒ
            # è¿™é‡Œå¯ä»¥è°ƒç”¨mainå‡½æ•°çš„æ ¸å¿ƒé€»è¾‘
            print(f"âœ… Experiment {i+1} completed")
            results.append({"config": config, "status": "success"})
            
        except Exception as e:
            print(f"âŒ Experiment {i+1} failed: {e}")
            results.append({"config": config, "status": "failed", "error": str(e)})
    
    return results


if __name__ == "__main__":
    # æ£€æŸ¥æ˜¯å¦æœ‰ç‰¹æ®Šå‘½ä»¤
    if len(sys.argv) > 1 and sys.argv[1] == "--batch":
        # æ‰¹é‡è¿è¡Œæ¨¡å¼
        print("ğŸ”„ Batch mode not implemented yet")
        
    elif len(sys.argv) > 1 and sys.argv[1] == "--analyze":
        # åˆ†ææ¨¡å¼
        output_dir = sys.argv[2] if len(sys.argv) > 2 else "./outputs/"
        create_intelligent_analysis_report(output_dir)
        
    else:
        # æ­£å¸¸è¿è¡Œæ¨¡å¼
        main()